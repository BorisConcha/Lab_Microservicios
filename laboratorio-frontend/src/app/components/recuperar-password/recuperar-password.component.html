<div class="container vh-100 d-flex align-items-center justify-content-center">
  <div class="row w-100 justify-content-center">
    <div class="col-lg-5 col-md-7 col-12">
      <div class="card shadow-lg border-0">
        <div class="card-body p-5">
          <div *ngIf="!emailEnviado && !passwordCambiada">
            <div class="text-center mb-4">
              <i class="fas fa-key fa-3x text-primary mb-3"></i>
              <h2 class="fw-bold">Recuperar Contraseña</h2>
              <p class="text-muted">Ingresa tu correo electrónico y te enviaremos un código de verificación</p>
            </div>
            
            <form [formGroup]="emailForm" (ngSubmit)="enviarCodigo()">
              <div class="mb-3">
                <label for="email" class="form-label">Correo Electrónico</label>
                <input 
                  type="email" 
                  class="form-control" 
                  id="email"
                  formControlName="email"
                  placeholder="ejemplo@correo.com"
                  [class.is-invalid]="emailControl?.invalid && (emailControl?.dirty || emailControl?.touched)">
                <div *ngIf="emailControl?.invalid && (emailControl?.dirty || emailControl?.touched)" class="invalid-feedback">
                  <div *ngIf="emailControl?.errors?.['required']">El correo es requerido</div>
                  <div *ngIf="emailControl?.errors?.['email']">Ingrese un correo válido</div>
                </div>
              </div>
              
              <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
              </div>
              
              <button 
                type="submit" 
                class="btn btn-primary w-100 mb-3"
                [disabled]="emailForm.invalid || loading">
                <span *ngIf="!loading">Enviar Código</span>
                <span *ngIf="loading">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Enviando...
                </span>
              </button>
              
              <div class="text-center">
                <a routerLink="/login" class="text-decoration-none">
                  <i class="fas fa-arrow-left"></i> Volver al inicio de sesión
                </a>
              </div>
            </form>
          </div>
          
          <div *ngIf="emailEnviado && !codigoVerificado && !passwordCambiada">
            <div class="text-center mb-4">
              <i class="fas fa-envelope-open-text fa-3x text-success mb-3"></i>
              <h2 class="fw-bold">Verificar Código</h2>
              <p class="text-muted">Hemos enviado un código de 6 dígitos a <strong>{{ emailUsuario }}</strong></p>
            </div>
            
            <form [formGroup]="codigoForm" (ngSubmit)="verificarCodigo()">
              <div class="mb-3">
                <label for="codigo" class="form-label">Código de Verificación</label>
                <input 
                  type="text" 
                  class="form-control text-center fs-4 letter-spacing-wide" 
                  id="codigo"
                  formControlName="codigo"
                  placeholder="000000"
                  maxlength="6"
                  [class.is-invalid]="codigoControl?.invalid && (codigoControl?.dirty || codigoControl?.touched)">
                <div *ngIf="codigoControl?.invalid && (codigoControl?.dirty || codigoControl?.touched)" class="invalid-feedback">
                  <div *ngIf="codigoControl?.errors?.['required']">El código es requerido</div>
                  <div *ngIf="codigoControl?.errors?.['pattern']">Ingrese un código válido de 6 dígitos</div>
                </div>
                <small class="text-muted d-block mt-2">Código generado: <strong>{{ codigoGenerado }}</strong> (para pruebas)</small>
              </div>
              
              <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
              </div>
              
              <button 
                type="submit" 
                class="btn btn-primary w-100 mb-3"
                [disabled]="codigoForm.invalid || loading">
                <span *ngIf="!loading">Verificar Código</span>
                <span *ngIf="loading">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Verificando...
                </span>
              </button>
              
              <div class="text-center">
                <button type="button" class="btn btn-link text-decoration-none p-0" (click)="reenviarCodigo()">
                  ¿No recibiste el código? Reenviar
                </button>
              </div>
            </form>
          </div>
          
          <div *ngIf="codigoVerificado && !passwordCambiada">
            <div class="text-center mb-4">
              <i class="fas fa-lock fa-3x text-primary mb-3"></i>
              <h2 class="fw-bold">Nueva Contraseña</h2>
              <p class="text-muted">Ingresa tu nueva contraseña</p>
            </div>
            
            <form [formGroup]="passwordForm" (ngSubmit)="cambiarPassword()">
              <div class="mb-3">
                <label for="newPassword" class="form-label">Nueva Contraseña</label>
                <input 
                  [type]="showPassword ? 'text' : 'password'" 
                  class="form-control" 
                  id="newPassword"
                  formControlName="newPassword"
                  placeholder="••••••••"
                  [class.is-invalid]="newPassword?.invalid && (newPassword?.dirty || newPassword?.touched)">
                <div *ngIf="newPassword?.invalid && (newPassword?.dirty || newPassword?.touched)" class="invalid-feedback">
                  <div *ngIf="newPassword?.errors?.['required']">La contraseña es requerida</div>
                  <div *ngIf="newPassword?.errors?.['minlength']">Mínimo 8 caracteres</div>
                  <div *ngIf="newPassword?.errors?.['maxlength']">Máximo 20 caracteres</div>
                  <div *ngIf="newPassword?.errors?.['pattern']">Debe incluir mayúscula, minúscula, número y carácter especial</div>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="confirmNewPassword" class="form-label">Confirmar Nueva Contraseña</label>
                <input 
                  [type]="showPassword ? 'text' : 'password'" 
                  class="form-control" 
                  id="confirmNewPassword"
                  formControlName="confirmNewPassword"
                  placeholder="••••••••"
                  [class.is-invalid]="confirmNewPassword?.invalid && (confirmNewPassword?.dirty || confirmNewPassword?.touched) ||
                                      passwordForm.errors?.['passwordMismatch']">
                <div *ngIf="confirmNewPassword?.invalid && (confirmNewPassword?.dirty || confirmNewPassword?.touched)" class="invalid-feedback">
                  <div *ngIf="confirmNewPassword?.errors?.['required']">Confirme la contraseña</div>
                </div>
                <div *ngIf="passwordForm.errors?.['passwordMismatch'] && confirmNewPassword?.dirty" class="invalid-feedback d-block">
                  Las contraseñas no coinciden
                </div>
              </div>
              
              <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="showPass" [(ngModel)]="showPassword" [ngModelOptions]="{standalone: true}">
                <label class="form-check-label" for="showPass">
                  Mostrar contraseñas
                </label>
              </div>
              
              <button 
                type="submit" 
                class="btn btn-primary w-100"
                [disabled]="passwordForm.invalid || loading">
                <span *ngIf="!loading">Cambiar Contraseña</span>
                <span *ngIf="loading">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Cambiando...
                </span>
              </button>
            </form>
          </div>
          
          <div *ngIf="passwordCambiada" class="text-center">
            <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
            <h2 class="fw-bold mb-3">¡Contraseña Cambiada!</h2>
            <p class="text-muted mb-4">Tu contraseña ha sido actualizada exitosamente</p>
            <a routerLink="/login" class="btn btn-primary btn-lg">
              Ir al Inicio de Sesión
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
